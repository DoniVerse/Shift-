<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Career Platform - Employer Profile</title>
    <link rel="stylesheet" href="employer-profile-styles.css">
</head>
<body>
    <div class="container">
        <div class="profile-card">
            <div class="header">
                <div class="close-btn" onclick="goBack()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>

        <div class="profile-section">
            <div class="profile-avatar">
                <img id="company-logo" src="" alt="Company Logo" style="display:none;max-width:80px;max-height:80px;border-radius:8px;" />
                <svg id="default-avatar" width="60" height="60" viewBox="0 0 24 24" fill="none">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                </svg>
            </div>
            <h1 class="company-name" id="profile-company-name"></h1>
            <!-- Logout button -->
            <button id="logout-btn" style="margin-top: 24px; width: 100%; padding: 10px 0; background: #dc2626; color: #fff; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">Logout</button>
        </div>

        <div class="menu-section">
            <div class="menu-item" onclick="showCompanyInfo()">
                <div class="menu-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 21H21M5 21V7L13 2L21 7V21M9 9H11M9 12H11M9 15H11M13 9H15M13 12H15M13 15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span class="menu-text">Company Information</span>
                <div class="menu-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <polyline points="9,18 15,12 9,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            <div class="menu-item" onclick="showJobInfo()">
                <div class="menu-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M20 7H4C2.89543 7 2 7.89543 2 9V19C2 20.1046 2.89543 21 4 21H20C21.1046 21 22 20.1046 22 19V9C22 7.89543 21.1046 7 20 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 21V5C16 4.46957 15.7893 3.96086 15.4142 3.58579C15.0391 3.21071 14.5304 3 14 3H10C9.46957 3 8.96086 3.21071 8.58579 3.58579C8.21071 3.96086 8 4.46957 8 5V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span class="menu-text">Job Postings</span>
                <div class="menu-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <polyline points="9,18 15,12 9,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            <div class="menu-item" onclick="viewApplications()">
                <div class="menu-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span class="menu-text">Job Applications</span>
                <div class="menu-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <polyline points="9,18 15,12 9,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="settings-section">
                </svg>
                <!-- Settings removed -->
            </div>
        </div>
        <!-- Applications list for rendering employer applications -->
        <div id="applications-list"></div>
    </div>

    <!-- Employer Notification Modal -->
    <div id="employerNotificationModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:2em;border-radius:8px;max-width:600px;width:90vw;max-height:80vh;overflow:auto;position:relative;">
        <button onclick="document.getElementById('employerNotificationModal').style.display='none'" style="position:absolute;top:10px;right:10px;font-size:1.5em;background:none;border:none;cursor:pointer;">✕</button>
        <h2>Notifications</h2>
        <div id="employerNotificationsList">Loading...</div>
      </div>
    </div>
    <!-- Add a button to open employer notifications -->
    <button onclick="document.getElementById('employerNotificationModal').style.display='flex'; loadEmployerNotifications();" style="position:fixed;bottom:80px;right:20px;z-index:10000;background:#2563eb;color:#fff;border:none;padding:12px 20px;border-radius:50px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:1.1em;cursor:pointer;">🔔 Notifications</button>

    <!-- Modal for different sections -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Section Title</h2>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be dynamically loaded here -->
            </div>
        </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.history.back();
        }

        // Load employer info from Firestore (always prefer Firestore, fallback to localStorage only if needed)
        async function loadEmployerInfo(user) {
            const { doc, getDoc, getFirestore } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            let employerInfo = null;
            try {
                // Use the global firebaseApp if available, else fallback
                const db = window.firebaseApp ? getFirestore(window.firebaseApp) : getFirestore();
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    employerInfo = userDoc.data();
                } else {
                    employerInfo = JSON.parse(localStorage.getItem('employerInfo'));
                }
            } catch (error) {
                employerInfo = JSON.parse(localStorage.getItem('employerInfo'));
            }
            // Update UI with all available employer fields
            if (employerInfo) {
                // Debug: log employerInfo to help diagnose missing fields
                console.log('Loaded employerInfo:', employerInfo);
                // Use the actual company name from signup, fallback to any available name
                let companyName = employerInfo.companyName || employerInfo.name || employerInfo.displayName || employerInfo.fullName || 'Company Name';
                // Always show the company name below the logo/avatar
                let nameElem = document.getElementById('profile-company-name');
                let logoElem = document.getElementById('company-logo');
                let avatarElem = document.getElementById('default-avatar');
                // If any of these elements are missing, create them and insert into .profile-section
                const profileSection = document.querySelector('.profile-section');
                if (!logoElem) {
                    logoElem = document.createElement('img');
                    logoElem.id = 'company-logo';
                    logoElem.alt = 'Company Logo';
                    logoElem.style = 'display:none;max-width:80px;max-height:80px;border-radius:8px;';
                    if (profileSection) profileSection.insertBefore(logoElem, profileSection.firstChild);
                    else console.warn('profile-section not found');
                }
                if (!avatarElem) {
                    avatarElem = document.createElement('svg');
                    avatarElem.id = 'default-avatar';
                    avatarElem.setAttribute('width', '60');
                    avatarElem.setAttribute('height', '60');
                    avatarElem.setAttribute('viewBox', '0 0 24 24');
                    avatarElem.setAttribute('fill', 'none');
                    avatarElem.innerHTML = '<path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>';
                    if (profileSection) profileSection.insertBefore(avatarElem, logoElem.nextSibling);
                }
                if (!nameElem) {
                    nameElem = document.createElement('h1');
                    nameElem.className = 'company-name';
                    nameElem.id = 'profile-company-name';
                    if (profileSection) profileSection.appendChild(nameElem);
                }
                nameElem.textContent = companyName;
                // Show logo if available, fallback to default avatar
                const logoUrl = employerInfo.logo || employerInfo.profilePicture || '';
                if (logoUrl) {
                    logoElem.src = logoUrl;
                    logoElem.style.display = 'block';
                    avatarElem.style.display = 'none';
                } else {
                    logoElem.style.display = 'none';
                    avatarElem.style.display = 'block';
                }
                // Optionally display more fields (phone, registration number, company type)
                let infoHtml = '';
                if (employerInfo.companyType) {
                    infoHtml += `<div><strong>Type:</strong> ${employerInfo.companyType}</div>`;
                }
                if (employerInfo.phone) {
                    infoHtml += `<div><strong>Phone:</strong> ${employerInfo.phone}</div>`;
                }
                if (employerInfo.registrationNumber) {
                    infoHtml += `<div><strong>Registration #:</strong> ${employerInfo.registrationNumber}</div>`;
                }
                if (employerInfo.email) {
                    infoHtml += `<div><strong>Email:</strong> ${employerInfo.email}</div>`;
                }
                // Insert into a new or existing div below the company name
                let detailsDiv = document.getElementById('profile-company-details');
                if (!detailsDiv) {
                    detailsDiv = document.createElement('div');
                    detailsDiv.id = 'profile-company-details';
                    detailsDiv.style.marginTop = '10px';
                    if (profileSection) profileSection.appendChild(detailsDiv);
                }
                detailsDiv.innerHTML = infoHtml;
            }
        }

        // Initialize profile when auth state changes
        if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChange === 'function') {
            window.firebaseAuth.onAuthStateChange(async (user) => {
                if (!user) {
                    window.location.href = 'employer-signin.html';
                    return;
                }
                await loadEmployerInfo(user);
            });
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function showCompanyInfo() {
            const user = window.firebaseAuth && window.firebaseAuth.currentUser;
            if (!user) {
                showModal('Company Information', '<div>Please sign in to view your company information.</div>');
                return;
            }
            // Fetch employer info from Firestore
            (async () => {
                const { doc, getDoc, getFirestore } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                try {
                    const db = window.firebaseApp ? getFirestore(window.firebaseApp) : getFirestore();
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    let employerInfo = null;
                    if (userDoc.exists()) {
                        employerInfo = userDoc.data();
                    } else {
                        employerInfo = JSON.parse(localStorage.getItem('employerInfo'));
                    }
                    if (!employerInfo) {
                        showModal('Company Information', '<div>Company information not found.</div>');
                        return;
                    }
                    let content = `<div class="info-section">`;
                    content += `<div class="info-item"><strong>Company Name:</strong> <span>${employerInfo.companyName || employerInfo.name || ''}</span></div>`;
                    if (employerInfo.companyType) {
                        content += `<div class="info-item"><strong>Type:</strong> <span>${employerInfo.companyType}</span></div>`;
                    }
                    if (employerInfo.phone) {
                        content += `<div class="info-item"><strong>Phone:</strong> <span>${employerInfo.phone}</span></div>`;
                    }
                    if (employerInfo.registrationNumber) {
                        content += `<div class="info-item"><strong>Registration #:</strong> <span>${employerInfo.registrationNumber}</span></div>`;
                    }
                    if (employerInfo.email) {
                        content += `<div class="info-item"><strong>Email:</strong> <span>${employerInfo.email}</span></div>`;
                    }
                    if (employerInfo.logo) {
                        content += `<div class="info-item"><strong>Logo:</strong><br><img src="${employerInfo.logo}" alt="Logo" style="max-width:80px;max-height:80px;border-radius:8px;margin-top:4px;" /></div>`;
                    }
                    content += `</div>`;
                    showModal('Company Information', content);
                } catch (e) {
                    showModal('Company Information', '<div>Error loading company information.</div>');
                }
            })();
        }

        function showJobInfo() {
            const user = window.firebaseAuth && window.firebaseAuth.currentUser;
            if (!user) {
                showModal('Job Postings', '<div>Please sign in to view your job postings.</div>');
                return;
            }

            const modal = document.getElementById('modal-overlay');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            modalTitle.textContent = 'Job Postings';
            modalBody.innerHTML = '<div>Loading job postings...</div>';
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            async function renderJobs(jobs) {
                if (!jobs.length) {
                    modalBody.innerHTML = '<div>No job postings yet. Add jobs from the Add-Job section.</div>';
                    return;
                }
                let content = '<div class="info-section">';
                jobs.forEach(job => {
                    content += `
                        <div class="job-card">
                            <div><strong>Title:</strong> ${job.title}</div>
                            <div><strong>Category:</strong> ${job.categoryTitle || job.category}</div>
                            <div><strong>Payment:</strong> ${job.paymentCode}</div>
                            <div><strong>Expected Hours:</strong> ${job.expectedHours || ''}</div>
                            <div><strong>Description:</strong> ${job.description}</div>
                        </div>
                        <hr />
                    `;
                });
                content += '</div>';
                modalBody.innerHTML = content;
            }

            // Always use user.uid here!
            window.jobManager.getJobsByEmployer(user.uid)
                .then(renderJobs)
                .catch(error => {
                    console.error('Error fetching jobs:', error);
                    modalBody.innerHTML = '<div>Error loading job postings. Please try again later.</div>';
                });
        }

        async function viewApplications() {
            const user = window.firebaseAuth.getCurrentUser();
            if (!user) {
                showModal('Job Applications', '<p>Please sign in to view applications.</p>');
                return;
            }
            showModal('Job Applications', '<p>Loading applications...</p>');
            let applications = [];
            try {
                if (window.jobManager && window.jobManager.getApplicationsByEmployer) {
                    applications = await window.jobManager.getApplicationsByEmployer(user.uid);
                }
            } catch (e) {
                // Fallback to localStorage only on error
                const allApps = JSON.parse(localStorage.getItem('applications') || '[]');
                const employerInfo = JSON.parse(localStorage.getItem('employerInfo'));
                applications = allApps.filter(app => app.employerEmail === (employerInfo?.email));
            }
            if (!applications.length) {
                showModal('Job Applications', '<p>No applications received yet.</p>');
                return;
            }
            let applicationsHTML = '<div style="max-height: 400px; overflow-y: auto;">';
            applications.forEach((app, index) => {
                const isAccepted = app.status === 'accepted';
                const isStarted = app.status === 'started';
                const isFinished = app.status === 'finished';
                applicationsHTML += `
                    <div id="application-card-${index}" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f9f9f9; position:relative;">
                        <h4>${app.jobTitle}</h4>
                        <p><strong>Applicant:</strong> ${app.studentName}</p>
                        <p><strong>Email:</strong> ${app.studentEmail}</p>
                        <p><strong>University:</strong> ${app.studentUniversity}</p>
                        <p><strong>Year of Study:</strong> ${app.studentYear}</p>
                        <p><strong>Department:</strong> ${app.studentDepartment}</p>
                        <p><strong>Applied:</strong> ${app.createdAt && app.createdAt.toDate ? app.createdAt.toDate().toLocaleDateString() : (app.appliedAt ? new Date(app.appliedAt).toLocaleDateString() : '')}</p>
                        <p><strong>Status:</strong> <span style="color: green;">${app.status}</span></p>
                        <div id="action-row-${index}" style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                            <button onclick="contactStudent('${app.studentEmail}', '${app.studentName}')" style="background: #d17e7e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Contact Student
                            </button>
                            ${isAccepted && !isStarted && !isFinished ? `<button id='start-btn-${index}' style='background: #eab308; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;'>Start</button>` : ''}
                            ${isAccepted && !isStarted && !isFinished ? `<button id='finished-btn-${index}' style='background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;'>Finished</button>` : ''}
                            ${isStarted && !isFinished ? `<button id='finished-btn-${index}' style='background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;'>Finished</button>` : ''}
                            ${isAccepted || isStarted ? `<span id="qr-code-${index}" style="margin-left: 10px; display:inline-block;"><img src='QR.jpg' alt='QR Code' style='display:inline-block;vertical-align:middle;margin-left:8px;border-radius:8px;width:320px;height:320px;' /></span>` : `<span id="qr-code-${index}" style="margin-left: 10px; display:none;"></span>`}
                            ${!isAccepted && !isStarted && !isFinished ? `<button id="accept-btn-${index}" onclick="window.handleApplicationAction && window.handleApplicationAction('${app.id}', 'accepted', '${app.studentId || ''}', ${index})" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Accept</button>` : ''}
                            ${!isAccepted && !isStarted && !isFinished ? `<button id="reject-btn-${index}" onclick="window.handleApplicationAction && window.handleApplicationAction('${app.id}', 'rejected', '${app.studentId || ''}')" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Reject</button>` : ''}
                        </div>
                    </div>
                `;
            });
            applicationsHTML += '</div>';
            showModal('Job Applications', applicationsHTML);

            // Add QR code and status logic for Accept/Start/Finished buttons
            applications.forEach((app, index) => {
                // Accept button logic (existing)
                const acceptBtn = document.getElementById(`accept-btn-${index}`);
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', function() {
                        setTimeout(() => {
                            const actionRow = document.getElementById(`action-row-${index}`);
                            if (actionRow) {
                                const accept = document.getElementById(`accept-btn-${index}`);
                                const reject = document.getElementById(`reject-btn-${index}`);
                                if (accept) accept.style.display = 'none';
                                if (reject) reject.style.display = 'none';
                                // Show QR code (persist and clickable)
                                const qrSpan = document.getElementById(`qr-code-${index}`);
                                if (qrSpan) {
                                    qrSpan.innerHTML = `<img src='QR.jpg' alt='QR Code' style='display:inline-block;vertical-align:middle;margin-left:8px;border-radius:8px;width:190px;height:190px;' />`;
                                    qrSpan.style.display = 'inline-block';
                                }
                                // Show Start and Finished buttons
                                let startBtn = document.getElementById(`start-btn-${index}`);
                                let finishedBtn = document.getElementById(`finished-btn-${index}`);
                                if (!startBtn) {
                                    startBtn = document.createElement('button');
                                    startBtn.id = `start-btn-${index}`;
                                    startBtn.textContent = 'Start';
                                    startBtn.style = 'background: #eab308; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;';
                                    actionRow.insertBefore(startBtn, qrSpan);
                                }
                                if (!finishedBtn) {
                                    finishedBtn = document.createElement('button');
                                    finishedBtn.id = `finished-btn-${index}`;
                                    finishedBtn.textContent = 'Finished';
                                    finishedBtn.style = 'background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;';
                                    actionRow.insertBefore(finishedBtn, qrSpan);
                                }
                                // Add event listeners
                                startBtn.onclick = async function() {
                                    await window.handleApplicationAction && window.handleApplicationAction(app.id, 'started', app.studentId || '', index);
                                };
                                finishedBtn.onclick = async function() {
                                    await window.handleApplicationAction && window.handleApplicationAction(app.id, 'finished', app.studentId || '', index);
                                    // Remove application card from view
                                    const card = document.getElementById(`application-card-${index}`);
                                    if (card) card.remove();
                                };
                            }
                        }, 200); // Wait for status update
                    });
                }
                // Start button logic (persist after refresh)
                const startBtn = document.getElementById(`start-btn-${index}`);
                if (startBtn) {
                    startBtn.onclick = async function() {
                        await window.handleApplicationAction && window.handleApplicationAction(app.id, 'started', app.studentId || '', index);
                    };
                }
                // Finished button logic (persist after refresh)
                const finishedBtn = document.getElementById(`finished-btn-${index}`);
                if (finishedBtn) {
                    finishedBtn.onclick = async function() {
                        await window.handleApplicationAction && window.handleApplicationAction(app.id, 'finished', app.studentId || '', index);
                        // Remove application card from view
                        const card = document.getElementById(`application-card-${index}`);
                        if (card) card.remove();
                    };
                }
            });
        }

        function contactStudent(email, name) {
            const subject = encodeURIComponent('Regarding Your Job Application');
            const body = encodeURIComponent(`Dear ${name},\\n\\nThank you for your application. We would like to discuss the opportunity further.\\n\\nBest regards,\\n${employerInfo?.name || 'Employer'}`);
            window.open(`mailto:${email}?subject=${subject}&body=${body}`);
        }

        async function updateApplicationStatusFirestore(appId, status) {
            if (!window.jobManager || !window.jobManager.applicationsCollection) {
                alert('Job manager not available.');
                return;
            }
            try {
                const db = window.jobManager.db;
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                await updateDoc(doc(db, window.jobManager.applicationsCollection, appId), { status });
                alert('Application status updated to: ' + status);
                viewApplications(); // Refresh
            } catch (e) {
                alert('Failed to update status: ' + e.message);
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Logout logic
        document.getElementById('logout-btn').addEventListener('click', function() {
            if (window.firebaseAuth && typeof window.firebaseAuth.signOutUser === 'function') {
                window.firebaseAuth.signOutUser();
            } else {
                localStorage.clear();
                window.location.href = 'employer-signin.html';
            }
        });
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (user.userType !== 'employer') {
        alert('Access denied. Only employers can access this page.');
        window.location.href = 'employer-signin.html';
    }
});
</script>
    <!-- Chat Widget Integration -->
    <script src="chat-integration-widget.js"></script>
    <script>
    // Pin admin account in chat sidebar for employer
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for chat widget to load
      function pinAdminInChat() {
        if (window.chatWidget && typeof window.chatWidget.pinContact === 'function') {
          // Replace with your actual admin account info
          window.chatWidget.pinContact({
            id: 'admin',
            name: 'Admin',
            email: 'admin@shift.com',
            avatar: 'https://cdn-icons-png.flaticon.com/512/149/149071.png', // Example avatar
            role: 'admin'
          });
        }
      }
      // Try immediately, and also after a short delay in case chatWidget loads late
      pinAdminInChat();
      setTimeout(pinAdminInChat, 1000);
    });
    </script>
    <script type="module">
      import { renderEmployerApplications } from './employer-applications-view.js';
      // Wait for Firebase Auth to be ready
      function renderProfileApplications() {
        const el = document.getElementById('applications-list');
        const user = window.firebaseAuth && window.firebaseAuth.currentUser;
        if (!el) {
          console.error('applications-list element not found!');
          return;
        }
        if (user) {
          renderEmployerApplications(el, user.uid);
        } 
      }
      if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChange === 'function') {
        window.firebaseAuth.onAuthStateChange(() => {
          document.addEventListener('DOMContentLoaded', renderProfileApplications);
        });
      } else {
        document.addEventListener('DOMContentLoaded', renderProfileApplications);
      }
    </script>
    <script type="module" src="firebase-auth.js"></script>
    <script type="module" src="firebase-jobs.js"></script>
    <!-- <script type="module" src="employer-applications.js"></script> -->
    <script type="module">
      // Ensure company logo and name are always loaded from Firestore
      document.addEventListener('DOMContentLoaded', async () => {
        const logoImg = document.getElementById('company-logo');
        const defaultAvatar = document.getElementById('default-avatar');
        const nameElem = document.getElementById('profile-company-name');
        if (!window.firebaseAuth) {
          console.error('firebaseAuth not found');
          if (nameElem) nameElem.textContent = 'Unable to load profile.';
          return;
        }
        window.firebaseAuth.onAuthStateChange(async (user) => {
          if (!user) {
            if (nameElem) nameElem.textContent = 'Please sign in as an employer.';
            if (logoImg) logoImg.style.display = 'none';
            if (defaultAvatar) defaultAvatar.style.display = '';
            return;
          }
          try {
            const db = window.firebaseFirestore || window.firebaseAuth.db || window.firebaseAuth.firestore || null;
            if (!db) {
              if (nameElem) nameElem.textContent = 'Firestore not available.';
              return;
            }
            const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists()) {
              if (nameElem) nameElem.textContent = 'Employer profile not found.';
              if (logoImg) logoImg.style.display = 'none';
              if (defaultAvatar) defaultAvatar.style.display = '';
              return;
            }
            const data = userDoc.data();
            // Set company name
            if (nameElem) nameElem.textContent = data.companyName || data.name || 'Company Name';
            // Set logo
            if (data.logo && logoImg) {
              logoImg.src = data.logo;
              logoImg.style.display = '';
              if (defaultAvatar) defaultAvatar.style.display = 'none';
            } else {
              if (logoImg) logoImg.style.display = 'none';
              if (defaultAvatar) defaultAvatar.style.display = '';
            }
          } catch (err) {
            console.error('Error loading employer profile:', err);
            if (nameElem) nameElem.textContent = 'Error loading profile.';
            if (logoImg) logoImg.style.display = 'none';
            if (defaultAvatar) defaultAvatar.style.display = '';
          }
        });
      });
    </script>
    
    <!-- Employer Notification System -->
    <script type="module">
    import { collection, getDocs, query, orderBy, doc, updateDoc, addDoc, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    
    window.loadEmployerNotifications = function() {
      const db = window.firebaseFirestore;
      const list = document.getElementById('employerNotificationsList');
      list.innerHTML = 'Loading...';

      if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChange === 'function') {
        window.firebaseAuth.onAuthStateChange(async (user) => {
          if (!user) {
            list.innerHTML = 'Please log in as an employer.';
            console.log('[Employer Notif] No user logged in');
            return;
          }
          try {
            console.log('[Employer Notif] Current user UID:', user.uid);
            const notifRef = collection(db, 'users', user.uid, 'notifications');
            const q = query(notifRef, orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            console.log('[Employer Notif] Notification docs:', snapshot.docs.map(d => d.data()));
            
            if (snapshot.empty) {
              list.innerHTML = 'No notifications yet.';
              console.log('[Employer Notif] No notifications found for user:', user.uid);
              return;
            }
            
            let html = '';
            snapshot.forEach(doc => {
              const notif = doc.data();
              const notifId = doc.id;
              
              if (notif.type === 'student_agreement_signed' && notif.requiresEmployerAgreement) {
                html += `
                    <div style="border:2px solid #22c55e; background:#d4edda; padding:15px; margin-bottom:15px; border-radius:8px;">
                        <div><strong>Status:</strong> <span style="color:#22c55e; font-weight:bold;">Student Agreement Signed by ${notif.studentName || 'Student'}</span></div>
                        <div><strong>Job:</strong> ${notif.jobTitle || ''}</div>
                        <div><strong>Message:</strong> ${notif.message || ''}</div>
                        <div style="font-size:0.9em;color:#64748b;">${notif.timestamp && notif.timestamp.toDate ? notif.timestamp.toDate().toLocaleString() : ''}</div>
                        
                        ${!notif.employerAgreementSigned ? `
                            <div style="margin-top:15px; padding-top:15px; border-top:2px solid #c3e6cb;">
                                <p style="margin:5px 0; color:#155724; font-weight:bold; font-size:16px;">📋 Action Required: Please sign the employer agreement to proceed</p>
                                <button onclick="showEmployerAgreement('${notif.applicationId}', '${notif.jobTitle}', '${notif.studentName}', '${notifId}')" 
                                        style="background:#28a745;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:bold;width:100%;font-size:16px;margin-top:10px;">
                                    📝 Sign Employer Agreement
                                </button>
                            </div>
                        ` : `
                            <div style="margin-top:10px; color:#155724; font-weight:bold; background:#c3e6cb; padding:10px; border-radius:6px;">
                                ✅ Employer Agreement Signed - Job can now begin
                            </div>
                        `}
                    </div>
                `;
              } else {
                html += `
                    <div style="border:1px solid #d1d5db; background:#f9fafb; padding:15px; margin-bottom:15px; border-radius:8px;">
                        <div><strong>Type:</strong> <span style="color:#64748b">${notif.type || 'notification'}</span></div>
                        <div><strong>Job:</strong> ${notif.jobTitle || ''}</div>
                        <div><strong>Message:</strong> ${notif.message || ''}</div>
                        <div style="font-size:0.9em;color:#64748b;">${notif.timestamp && notif.timestamp.toDate ? notif.timestamp.toDate().toLocaleString() : ''}</div>
                    </div>
                `;
              }
            });
            list.innerHTML = html;
            console.log('[Employer Notif] Rendered notifications for user:', user.uid);
          } catch (err) {
            list.innerHTML = 'Error loading notifications: ' + err.message;
            console.error('[Employer Notif] Error loading notifications:', err);
          }
        });
      } else {
        list.innerHTML = 'Authentication system not available.';
        console.log('[Employer Notif] window.firebaseAuth or onAuthStateChange not available');
      }
    };

    // Employer Agreement Modal Function
    window.showEmployerAgreement = async function(applicationId, jobTitle, studentName, notificationId) {
        const user = window.firebaseAuth?.currentUser;
        if (!user) {
            alert('Please log in to continue.');
            return;
        }
        
        // Get employer info from Firestore
        let employerInfo = {};
        try {
            const db = window.firebaseFirestore;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                employerInfo = userDoc.data();
            }
        } catch (error) {
            console.error('Error fetching employer info:', error);
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10000;';
        
        modal.innerHTML = `
            <div style="background:#fff;padding:30px;border-radius:12px;max-width:800px;width:90%;max-height:90%;overflow-y:auto;">
                <h2 style="color:#2563eb;margin-bottom:20px;">📄 CONTRACT 2: SHIFT – Company Partnership Agreement</h2>
                <p style="margin-bottom:15px;"><strong>(Part-Time Student Placement Contract)</strong></p>
                <p style="margin-bottom:20px;">This agreement ("Agreement") is made on <strong>${new Date().toLocaleDateString()}</strong> by and between:</p>
                
                <div style="border:1px solid #e5e7eb;padding:20px;border-radius:8px;background:#f9fafb;margin-bottom:20px;max-height:300px;overflow-y:auto;">
                    <p><strong>SHIFT</strong> – a youth-led innovation platform based in Addis Ababa, Ethiopia, hereinafter referred to as "SHIFT"</p>
                    <p><strong>AND</strong></p>
                    <p>Company Name: <strong>${employerInfo.companyName || '[To be filled below]'}</strong><br>
                    Representative: <strong>${employerInfo.name || user.displayName || '[Full Name]'}</strong>, <strong>[Title]</strong><br>
                    Phone: <strong>[To be filled below]</strong><br>
                    Email: <strong>${employerInfo.email || user.email || '[Email Address]'}</strong></p>
                    
                    <hr style="margin:15px 0;">
                    
                    <h4>1. Legal Framework</h4>
                    <p><strong>Offer:</strong> SHIFT offers to provide vetted, trained student workers for part-time assignments.</p>
                    <p><strong>Acceptance:</strong> The Company accepts the offer by signing this contract.</p>
                    <p><strong>Awareness:</strong> Both parties understand and voluntarily agree to all terms.</p>
                    <p><strong>Consideration:</strong> The Company gains access to screened student talent; SHIFT receives a service fee.</p>
                    <p><strong>Capacity:</strong> The Company confirms it is authorized and capable of entering into this agreement.</p>
                    <p><strong>Legality:</strong> This agreement is governed by Ethiopian labor and business law.</p>
                    
                    <h4>2. Purpose</h4>
                    <p>To establish a working relationship in which SHIFT supplies qualified student workers for short-term or part-time tasks.</p>
                    
                    <h4>3. Company Responsibilities</h4>
                    <ul>
                        <li>Provide clear job descriptions, expected tasks, compensation terms, and timelines.</li>
                        <li>Ensure a safe and lawful work environment.</li>
                        <li>Rate student performance upon task or contract completion.</li>
                        <li>Communicate with SHIFT regarding job performance, discipline, or early termination.</li>
                    </ul>
                    
                    <h4>4. Payment & Commission Terms</h4>
                    <ul>
                        <li>The Company agrees to compensate the student based on agreed job terms.</li>
                        <li>A 10%–15% platform commission shall be paid to SHIFT based on the total compensation paid to the student, or a negotiated flat fee.</li>
                        <li>Higher commission rates may apply for high-volume recruitment, premium student sourcing, or urgent placements.</li>
                        <li>Receipts and documentation are required for payment and auditing purposes.</li>
                    </ul>
                    
                    <h4>5. Performance & Evaluation</h4>
                    <ul>
                        <li>The Company agrees to rate student performance via a simple evaluation form provided by SHIFT.</li>
                        <li>In cases of incomplete work or misconduct, the Company should notify SHIFT immediately for intervention.</li>
                    </ul>
                    
                    <h4>6. Termination</h4>
                    <p>Either party may terminate this agreement with 5 business days' notice. Breach of agreement, unethical treatment of students, or payment failure can result in immediate termination.</p>
                    
                    <h4>7. Confidentiality & Data</h4>
                    <p>All shared student profiles and company needs shall remain confidential. Neither party may disclose data, job details, or project information to third parties without consent.</p>
                </div>
                
                <form id="employerAgreementForm">
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Company Name:</label>
                        <input type="text" id="employerCompanyName" value="${employerInfo.companyName || ''}" placeholder="Enter your company name" required style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Phone Number:</label>
                        <input type="tel" id="employerPhone" value="${employerInfo.phone || ''}" placeholder="Enter your phone number" required style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Your Title/Position:</label>
                        <input type="text" id="employerTitle" placeholder="e.g., CEO, HR Manager, etc." required style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Digital Signature (Type your full name):</label>
                        <input type="text" id="employerSignature" placeholder="Type your full name as signature" required style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;">
                    </div>
                    
                    <label style="display:flex;align-items:flex-start;margin-bottom:20px;cursor:pointer;">
                        <input type="checkbox" id="employerAgreementCheckbox" required style="margin-right:10px;margin-top:2px;transform:scale(1.2);">
                        <span style="font-size:14px;"><strong style="color:#dc2626;">I have read and agree to the terms and conditions of this Company Partnership Agreement.</strong></span>
                    </label>
                    
                    <div style="display:flex;gap:10px;">
                        <button type="submit" style="background:#22c55e;color:#fff;border:none;padding:15px 30px;border-radius:6px;cursor:pointer;flex:1;font-size:16px;font-weight:bold;">✅ Sign Agreement</button>
                        <button type="button" onclick="this.closest('[style*=\"position:fixed\"]').remove()" style="background:#6b7280;color:#fff;border:none;padding:15px 30px;border-radius:6px;cursor:pointer;font-size:16px;">Cancel</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('employerAgreementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const companyName = document.getElementById('employerCompanyName').value.trim();
            const phone = document.getElementById('employerPhone').value.trim();
            const title = document.getElementById('employerTitle').value.trim();
            const signature = document.getElementById('employerSignature').value.trim();
            const agreed = document.getElementById('employerAgreementCheckbox').checked;
            
            if (!companyName || !phone || !title || !signature || !agreed) {
                alert('Please fill all fields and agree to the terms.');
                return;
            }
            
            try {
                await saveEmployerAgreement(applicationId, jobTitle, studentName, companyName, phone, title, signature, notificationId);
                modal.remove();
                alert('Agreement signed successfully! The job can now begin.');
                loadEmployerNotifications(); // Reload notifications
            } catch (error) {
                console.error('Error saving agreement:', error);
                alert('Error saving agreement. Please try again.');
            }
        });
    };

    // Save Employer Agreement
    window.saveEmployerAgreement = async function(applicationId, jobTitle, studentName, companyName, phone, title, signature, notificationId) {
        const auth = window.firebaseAuth;
        const db = window.firebaseFirestore;
        const currentUser = auth?.currentUser;
        
        if (!currentUser || !db) {
            throw new Error('Authentication required');
        }
        
        // Save agreement to agreements collection
        const agreementData = {
            type: 'employer',
            applicationId,
            jobTitle,
            studentName,
            employerId: currentUser.uid,
            employerName: currentUser.displayName || signature,
            employerEmail: currentUser.email,
            companyName,
            employerPhone: phone,
            employerTitle: title,
            employerSignature: signature,
            signedAt: serverTimestamp(),
            status: 'signed',
            agreementDate: new Date().toLocaleDateString()
        };
        
        await addDoc(collection(db, 'agreements'), agreementData);
        
        // Update application status
        const appRef = doc(db, 'applications', applicationId);
        await updateDoc(appRef, {
            employerAgreementSigned: true,
            employerAgreementSignedAt: serverTimestamp(),
            employerPhone: phone,
            companyName: companyName,
            employerTitle: title,
            status: 'ready_to_start' // Both agreements signed, job can begin
        });
        
        // Update notification
        const notifRef = doc(db, 'users', currentUser.uid, 'notifications', notificationId);
        await updateDoc(notifRef, {
            employerAgreementSigned: true
        });
        
        // Get application data to notify student that job can begin
        const appDoc = await getDoc(appRef);
        if (appDoc.exists()) {
            const appData = appDoc.data();
            
            // Notify student that both agreements are signed and job can begin
            const studentNotifRef = collection(db, 'users', appData.studentId, 'notifications');
            await addDoc(studentNotifRef, {
                type: 'job_ready_to_start',
                applicationId,
                jobTitle,
                employerName: companyName,
                message: `Both agreements have been signed! Your job "${jobTitle}" with ${companyName} is ready to begin. Please coordinate with your employer for the start time.`,
                timestamp: serverTimestamp()
            });
        }
        
        console.log('Employer agreement saved successfully');
    };

    // Add this script section to handle notifications properly
    document.addEventListener('DOMContentLoaded', async function() {
        // Wait for Firebase to load
        setTimeout(async () => {
            if (window.firebaseAuth && window.firebaseFirestore) {
                loadEmployerNotifications();
            }
        }, 2000);
    });
    </script>
  </body>
</html>
