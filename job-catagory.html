<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Career Platform - Job Categories</title>
    <link rel="stylesheet" href="job-categories-styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="shift.jpg" alt="Shift Logo" style="width: 80px; height: 80px; border-radius: 50%;">
            </div>
            <h1 class="page-title">Job Listing</h1>
            <div class="spacer"></div>
        </div>



        <div class="content" style="padding: 24px;">
            <div id="myJobsHeader" style="font-weight:600;margin-bottom:12px;">My Posted Jobs</div>
            <div id="myJobsList" style="display:grid;grid-template-columns:1fr;gap:12px;"></div>
        </div>

        <div class="bottom-nav">
            <a href="dashboard.html" class="nav-item active">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Home</span>
            </a>
            <a href="chat.html" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Messages</span>
            </a>
            <a href="employer-profile.html" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>Profile</span>
            </a>
            <!-- Applications nav item -->
            <!-- <a href="#" class="nav-item" id="applicationsNav">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M8 6H21M8 12H21M8 18H21M3 6H3.01M3 12H3.01M3 18H3.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Applications</span>
            </a> -->
        </div>
        <div id="applicationsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;"></div>
    </div>

    <script type="module">
      import { renderEmployerApplications } from './employer-applications-view.js';
      document.addEventListener('DOMContentLoaded', () => {
        const applicationsNav = document.getElementById('applicationsNav');
        if (applicationsNav) {
          applicationsNav.addEventListener('click', async function(e) {
            e.preventDefault();
            const modal = document.getElementById('applicationsModal');
            modal.style.display = 'flex';
            modal.innerHTML = '<div style="background:#fff;padding:2em;border-radius:8px;max-width:600px;width:90vw;max-height:80vh;overflow:auto;"><h2>Job Applications</h2><div id="modalApplicationsList">Loading...</div><button onclick="document.getElementById(\'applicationsModal\').style.display=\'none\'" style="margin-top:1em;">Close</button></div>';
            const user = window.firebaseAuth && window.firebaseAuth.currentUser;
            if (user) {
              await renderEmployerApplications(document.getElementById('modalApplicationsList'), user.uid);
            } else {
              document.getElementById('modalApplicationsList').innerHTML = 'Please log in as an employer.';
            }
          });
        }
      });
    </script>
    <script type="module" src="firebase-auth.js"></script>
    <script type="module" src="firebase-jobs.js"></script>
    <script>
      // Accept/Reject handler for modal
      window.handleApplicationAction = async function(appId, action) {
        const db = window.firebaseFirestore;
        if (!confirm(`Are you sure you want to ${action} this application?`)) return;
        try {
          const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
          const appDocRef = doc(db, 'applications', appId);
          await updateDoc(appDocRef, { status: action });

          // Optionally, re-render the modal applications list
          const user = window.firebaseAuth && window.firebaseAuth.currentUser;
          if (user) {
            const { renderEmployerApplications } = await import('./employer-applications-view.js');
            await renderEmployerApplications(document.getElementById('modalApplicationsList'), user.uid);
          }
        } catch (err) {

        }
      };
    </script>
    <script>
        function goToAddJob() {
            window.location.href = 'add-job.html';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (user.userType !== 'employer') {
                alert('Access denied. Only employers can access this page.');
                window.location.href = 'student-profile.html';
            }

            // Render my jobs (Firebase preferred)
            const myJobsList = document.getElementById('myJobsList');
            async function renderMyJobsWithUid(uid) {
                myJobsList.innerHTML = '<div style="text-align:center;color:#666;">Loading your jobs...</div>';
                try {
                    let jobs = [];
                    if (uid && window.jobManager && typeof window.jobManager.getJobsByEmployer === 'function') {
                        jobs = await window.jobManager.getJobsByEmployer(uid);
                    }
                    // Fallback to local jobs by email
                    if (!jobs || jobs.length === 0) {
                        const allLocalJobs = JSON.parse(localStorage.getItem('jobs') || '[]');
                        const employerEmail = (JSON.parse(localStorage.getItem('employerInfo') || '{}').email) || (JSON.parse(localStorage.getItem('currentUser') || '{}').email) || '';
                        jobs = allLocalJobs.filter(j => j.employerEmail === employerEmail);
                    }
                    if (!jobs || jobs.length === 0) {
                        myJobsList.innerHTML = '<div style="text-align:center;color:#999;">No jobs posted yet.</div>';
                        return;
                    }
                    myJobsList.innerHTML = '';
                    jobs.forEach(job => {
                        const card = document.createElement('div');
                        card.style.border = '1px solid #e5e7eb';
                        card.style.borderRadius = '10px';
                        card.style.padding = '12px';
                        card.style.background = '#fff';
                        card.innerHTML = `
                            <div style="font-weight:600;margin-bottom:6px;">${job.title || ''}</div>
                            <div style="color:#555;margin-bottom:6px;">${job.description || ''}</div>
                            <div style="font-size:12px;color:#666;">Department: ${job.department || 'General'}</div>
                        `;
                        myJobsList.appendChild(card);
                    });
                } catch (e) {
                    myJobsList.innerHTML = '<div style="text-align:center;color:#999;">Failed to load jobs.</div>';
                }
            }
            // Wait for auth to ensure uid is ready
            if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChange === 'function') {
                window.firebaseAuth.onAuthStateChange(function(firebaseUser) {
                    const uid = firebaseUser ? firebaseUser.uid : '';
                    renderMyJobsWithUid(uid);
                });
            } else {
                const uid = (window.firebaseAuth && window.firebaseAuth.currentUser && window.firebaseAuth.currentUser.uid) || '';
                renderMyJobsWithUid(uid);
            }
        });


    </script>

    <!-- Chat Integration -->
    <script src="chat-integration-widget.js"></script>
    <script src="chat-buttons.js"></script>
    <script>
const applicationsNavBtn = document.getElementById('applicationsNav');
if (applicationsNavBtn) {
    applicationsNavBtn.onclick = function(e) {
        e.preventDefault();
        const employer = JSON.parse(localStorage.getItem('employerInfo') || '{}');
        const jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
        const applications = JSON.parse(localStorage.getItem('jobApplications') || '[]');
        // Find jobs posted by this employer
        const myJobs = jobs.filter(job => job.employerEmail === employer.email);
        // Find applications for these jobs
        const myJobTitles = myJobs.map(j => j.title);
        const myApplications = applications.filter(app => myJobTitles.includes(app.jobTitle));
        const modal = document.getElementById('applicationsModal');
        if (!myApplications.length) {
            modal.innerHTML = `<div style='background:#fff;padding:24px 20px 20px 20px;border-radius:12px;max-width:400px;width:90vw;position:relative;'><button id='closeApplicationsModal' style='position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;'>&times;</button><h2>Applications</h2><div>No applications yet.</div></div>`;
            modal.style.display = 'flex';
            document.getElementById('closeApplicationsModal').onclick = function() { modal.style.display = 'none'; };
            return;
        }
        let html = `<div style='background:#fff;padding:24px 20px 20px 20px;border-radius:12px;max-width:400px;width:90vw;position:relative;'><button id='closeApplicationsModal' style='position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;'>&times;</button><h2>Applications</h2>`;
        myApplications.forEach((app, idx) => {
            html += `<div class='application-card' style='border:1px solid #e1e5e9;border-radius:8px;padding:12px;margin-bottom:12px;cursor:pointer;' data-idx='${idx}'>
                <div><strong>Job:</strong> ${app.jobTitle}</div>
                <div><strong>Student:</strong> ${app.student}</div>
                <div><strong>Date:</strong> ${app.dateApplied}</div>
                <div><strong>Status:</strong> ${app.status}</div>
            </div>`;
        });
        html += `</div>`;
        modal.innerHTML = html;
        modal.style.display = 'flex';
        document.getElementById('closeApplicationsModal').onclick = function() { modal.style.display = 'none'; };
        // Add click handler for each application card
        modal.querySelectorAll('.application-card').forEach(card => {
            card.onclick = function() {
                const idx = this.getAttribute('data-idx');
                const app = myApplications[idx];
                // Get student info
                const students = [JSON.parse(localStorage.getItem('currentUser') || '{}')];
                const student = students.find(s => s.email === app.student) || {};
                const resume = JSON.parse(localStorage.getItem('resumeData') || '{}');
                const education = JSON.parse(localStorage.getItem('educationData') || '{}');
                let details = `<div style='background:#fff;padding:24px 20px 20px 20px;border-radius:12px;max-width:400px;width:90vw;position:relative;'><button id='closeStudentModal' style='position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;'>&times;</button><h2>Student Info</h2>`;
                details += `<div><strong>Name:</strong> ${student.name || app.student}</div>`;
                details += `<div><strong>Year of Study:</strong> ${student.yearOfStudy || ''}</div>`;
                if (resume.fileName) details += `<div><strong>Resume/CV:</strong> ${resume.fileName}</div>`;
                if (education.gpa) details += `<div><strong>GPA:</strong> ${education.gpa}</div>`;
                if (education.graduationDate) details += `<div><strong>Expected Graduation:</strong> ${education.graduationDate}</div>`;
                details += `<button id='acceptStudentBtn' style='width:100%;padding:10px 0;background:#22c55e;color:#fff;border:none;border-radius:6px;font-size:1rem;cursor:pointer;margin-top:16px;'>Accept</button>`;
                details += `</div>`;
                modal.innerHTML = details;
                document.getElementById('closeStudentModal').onclick = function() { modal.style.display = 'none'; };
                document.getElementById('acceptStudentBtn').onclick = function() {
                    // Store notification for student
                    const notifications = JSON.parse(localStorage.getItem('studentNotifications') || '[]');
                    notifications.push({
                        email: app.student,
                        message: `You have been accepted for the job: ${app.jobTitle}`,
                        date: new Date().toLocaleString()
                    });
                    localStorage.setItem('studentNotifications', JSON.stringify(notifications));

                    modal.style.display = 'none';
                };
            };
        });
    };
}
</script>

<!-- Floating Post Job Button -->
<button onclick="goToAddJob()" style="position:fixed;right:20px;bottom:80px;width:56px;height:56px;border-radius:50%;background:var(--color-primary);color:#fff;border:none;font-size:28px;box-shadow:0 6px 16px rgba(0,0,0,0.2);cursor:pointer;z-index:1000;">+</button>
</body>
</html>
