<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift - Add Job</title>
    <link rel="stylesheet" href="add-job-styles.css">
    <script type="module" src="firebase-auth.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="logo">S</div>
            <div class="spacer"></div>
        </div>

        <div class="content">
            <h1 class="page-title">Add Job Details</h1>
            
            <form id="job-form" class="job-form">
                <div class="form-group">
                    <label for="job-title">Job Title</label>
                    <input type="text" id="job-title" placeholder="e.g., Intellectual Property Law" required>
                </div>

                <div class="form-group">
                    <label for="job-description">Description:</label>
                    <textarea id="job-description" placeholder="‚Ä¢ Describe the main responsibilities and duties
‚Ä¢ Add key focus areas of the role
‚Ä¢ Include any specific legal areas covered
‚Ä¢ Mention client interaction requirements" rows="8" required></textarea>
                </div>



                <div class="payment-section">
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="payment-code">Payment amount</label>
                            <input type="text" id="payment-code" placeholder="e.g., ETB 200" required>
                        </div>
                        <div class="form-group half">
                            <label for="expected-hours">Expected Hours to Finish</label>
                            <input type="number" id="expected-hours" placeholder="e.g., 4" min="1" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="job-department">Department for this job</label>
                    <select id="job-department" required>
                        <option value="">Select Department</option>
                        <option value="Law">Law</option>
                        <option value="Economics">Economics</option>
                        <option value="public administration and development managment">public administration and development managment</option>
                        <option value="Marketing Management">Marketing Management</option>
                        <option value="Business Administration and information system">Business Administration and information system</option>
                        <option value="Accounting">Accounting</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Logic and supply vhain management">Logic and supply vhain management</option>
                        <option value="Management">Management</option>
                        <option value="chemistry">chemistry</option>
                        <option value="Computer science">Computer science</option>
                        <option value="Information system">Information system</option>
                        <option value="Psychology">Psychology</option>
                        <option value="physics">physics</option>
                        <option value="Staticts">Staticts</option>
                        <option value="Biology">Biology</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Chemical Engineering">Chemical Engineering</option>
                        <option value="Biomedical Engineering">Biomedical Engineering</option>
                        <option value="Civil Engineering">Civil Engineering</option>
                        <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                        <option value="Mechanical Engineering">Mechanical Engineering</option>
                        <option value="Software Engineering and computer Technology">Software Engineering and computer Technology</option>
                        <option value="Architecture">Architecture</option>
                        <option value="Construction Technology and management">Construction Technology and management</option>
                        <option value="Urban planning and Design">Urban planning and Design</option>
                    </select>
                </div>

                <button type="submit" class="publish-btn">Publish Job</button>
            </form>
        </div>

        <div class="bottom-nav">
            <a href="dashboard.html" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Home</span>
            </a>
            <a href="messages.html" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Messages</span>
            </a>
            <a href="employer-profile.html" class="nav-item active">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <script>
        function goBack() {
            window.history.back();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Make user available everywhere in this script
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');

            // Wait for Firebase Auth to be ready using onAuthStateChange
            if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChange === 'function') {
                window.firebaseAuth.onAuthStateChange(function(firebaseUser) {
                    if (!firebaseUser) {

                        window.location.href = 'employer-signin.html';
                        return;
                    }
                    if (user.userType !== 'employer') {
                        alert('Access denied. Only employers can access this page.');
                        window.location.href = 'student-profile.html';
                        return;
                    }
                    // Place the rest of your page logic here (e.g., form event listeners, etc.)
                    document.getElementById('job-form').addEventListener('submit', async function(e) {
                        e.preventDefault();

                        const jobTitle = document.getElementById('job-title').value;
                        const jobDescription = document.getElementById('job-description').value;
                        const paymentCode = document.getElementById('payment-code').value;
                        const expectedHours = document.getElementById('expected-hours').value;
                        const selectedDepartment = document.getElementById('job-department').value;
                        // No category flow; department-based matching
                        const urlParams = new URLSearchParams(window.location.search);
                        const category = '';
                        const categoryTitle = '';
                        // Get employer info from both possible sources
                        const employerInfo = JSON.parse(localStorage.getItem('employerInfo') || '{}');
                        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

                        // Use employerInfo if available, otherwise use currentUser
                        const employer = {
                            name: employerInfo.name || currentUser.name || '',
                            email: employerInfo.email || currentUser.email || ''
                        };
                        // Get employer Firebase UID
                        const employerUid = window.firebaseAuth && window.firebaseAuth.currentUser ? window.firebaseAuth.currentUser.uid : null;

                        if (!employerUid) {

                            window.location.href = 'employer-signin.html';
                            return;
                        }

                        console.log('üîç Job submission data:');
                        console.log('üìù Title:', jobTitle);
                        console.log('üìù Description:', jobDescription);
                        console.log('üìù Payment:', paymentCode);
                        console.log('üìù Hours:', expectedHours);
                        // Department will be attached automatically from employer profile
                        console.log('üë§ Employer info:', employer);
                        console.log('üè∑Ô∏è Department:', selectedDepartment);

                        // Show debug alert to user
                        const debugInfo = `
üîç JOB SUBMISSION DEBUG:
Title: ${jobTitle}
Employer: ${employer.name || 'MISSING'}
Email: ${employer.email || 'MISSING'}

Continue with publishing?
            `;

                        if (!confirm(debugInfo)) {
                            return;
                        }

                        if (jobTitle && jobDescription && paymentCode && expectedHours && selectedDepartment) {
                            // Show loading message
                            const submitBtn = document.querySelector('.publish-btn');
                            const originalText = submitBtn.textContent;
                            submitBtn.textContent = 'Publishing...';
                            submitBtn.disabled = true;

                            try {
                                // Build job object from form values
                                const job = {
                                    title: jobTitle,
                                    description: jobDescription,
                                    paymentCode: paymentCode,
                                    expectedHours: expectedHours,
                                    department: selectedDepartment,
                                    employerName: employer.name || '',
                                    employerEmail: employer.email || '',
                                    employerId: employerUid // Always set employerId to Firebase UID
                                };

                                // Try Firebase first, then fallback to local
                                let result;
                                try {
                                    if (window.jobManager) {
                                        console.log('üî• Attempting Firebase job publishing...');
                                        result = await window.jobManager.publishJob(job);
                                        console.log('üî• Firebase result:', result);
                                    } else {
                                        throw new Error('Firebase jobManager not available');
                                    }
                                } catch (firebaseError) {
                                    console.error('üî• Firebase failed:', firebaseError);
                                    console.error('üî• Error code:', firebaseError.code);
                                    console.error('üî• Error message:', firebaseError.message);



                                    console.log('üì± Using local storage fallback...');
                                    result = window.localJobsManager.publishJob(job);
                                    console.log('üì± Local result:', result);
                                }

                                if (result.success) {

                                    window.location.href = 'job-catagory.html';
                                } else {
                                    throw new Error(result.error);
                                }
                            } catch (error) {
                                console.error('Error publishing job:', error);

                                let errorMessage = '';
                                if (error.message.includes('permission') || error.message.includes('insufficient')) {
                                    errorMessage = `üîí Firebase Permission Error\n\nThis happens because Firebase security rules need to be configured.\n\nFor now, your job will be saved locally and visible on this device.`;
                                } else {
                                    errorMessage = `‚ùå Network Error: ${error.message}\n\nYour job will be saved locally.`;
                                }



                                // Fallback to localStorage
                                const job = {
                                    title: jobTitle,
                                    description: jobDescription,
                                    paymentCode: paymentCode,
                                    expectedHours: expectedHours,
                                    department: selectedDepartment,
                                    employerName: employer.name || '',
                                    employerEmail: employer.email || '',
                                    timestamp: Date.now(),
                                    source: 'localStorage' // Mark as local
                                };
                                const jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
                                jobs.push(job);
                                localStorage.setItem('jobs', JSON.stringify(jobs));

                                window.location.href = 'job-catagory.html';
                            } finally {
                                // Reset button
                                submitBtn.textContent = originalText;
                                submitBtn.disabled = false;
                            }
                        } else {

                        }
                    });

                    // Auto-resize textareas
                    const textareas = document.querySelectorAll('textarea');
                    textareas.forEach(textarea => {
                        textarea.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = this.scrollHeight + 'px';
                        });
                    });

                    // Form validation
                    const inputs = document.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        input.addEventListener('blur', function() {
                            if (this.hasAttribute('required') && !this.value.trim()) {
                                this.style.borderColor = '#dc2626';
                            } else {
                                this.style.borderColor = 'var(--color-primary)';
                            }
                        });
                    });
                });
            } else {
                // Fallback if onAuthStateChange is not available (should ideally not happen with current setup)

                window.location.href = 'employer-signin.html'; // Redirect to login if auth is not ready
            }
        });
    </script>
    <!-- Local Jobs Management (Primary) -->
    <script src="local-jobs-manager.js"></script>
    <!-- Firebase Jobs Management (Fallback) -->
    <script type="module" src="firebase-jobs.js"></script>
</body>
</html>
